
<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Operational Metrics - Demo</title>
    <style>
        body { font-family: system-ui, Arial; padding: 16px; }
        table { border-collapse: collapse; width: 100%; max-width: 1200px; }
        th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; font-size: 13px; }
        th { background: #f4f4f4; position: sticky; top: 0; }
        .container { max-height: 60vh; overflow: auto; margin-bottom: 12px; border: 1px solid #eee; padding: 8px; }
        .controls { margin-bottom: 12px; }
        button { padding: 6px 10px; }
        .answer { font-weight: 600; margin-top: 8px; }
    </style>
</head>
<body>
    <div class="controls">
        <label>Email for seed: <input id="email" value="24f3001383@ds.study.iitm.ac.in" /></label>
        <button id="generate">Generate & Render</button>
        <button id="download" disabled>Download Excel</button>
        <div class="answer" id="answer"></div>
    </div>

    <div class="container" id="tableContainer"></div>

    <script type="module">
        import seedrandom from "https://cdn.jsdelivr.net/npm/seedrandom/+esm";
        import * as XLSX from "https://cdn.jsdelivr.net/npm/xlsx/+esm";

    // Utilities
            const fmtMoney = (n) => {
                const nf = new Intl.NumberFormat("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                return "$" + nf.format(n);
            };
            const randomDateBetween = (a, b, rnd) => {
                const t = a.getTime() + rnd() * (b.getTime() - a.getTime());
                return new Date(t);
            };
            const addRandomSpaces = (s, rnd) => {
                const left = " ".repeat(Math.floor(rnd() * 3));
                const right = " ".repeat(Math.floor(rnd() * 2));
                return left + s + right;
            };
    
            // simple picker that uses the seeded RNG
            const pick = (arr, rnd) => arr[Math.floor(rnd() * arr.length)];

        // Domain lists (same as original)
        const regions = [
            { canonical: "North America", variants: ["NorthAmerica", "N. America", "N America", "North-Am"] },
            { canonical: "Latin America", variants: ["LatAm", "Latin-America", "LAT AM", "LatinAmerica"] },
            { canonical: "Europe", variants: ["EU", "Europa", "Europe Region", "E.U."] },
            { canonical: "Middle East & Africa", variants: ["MEA", "MiddleEast&Africa", "M. East Africa", "Middle East/Africa"] },
            { canonical: "Asia Pacific", variants: ["APAC", "Asia-Pacific", "AsiaPac", "Asia Pacific Region"] }
        ];
        const categories = ["Fulfillment", "Returns", "Support", "Logistics", "Billing", "Onboarding"];
        const teams = ["Ops Control", "Warehouse", "Customer Care", "Payments", "Routing", "Automation", "Partner Success"];
        const dateFormats = [
            d => d.toISOString().split("T")[0],
            d => `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`,
            d => `${d.toLocaleString("en-US", { month: "short" })} ${String(d.getDate()).padStart(2,"0")}, ${d.getFullYear()}`,
            d => `${d.getFullYear()} Q${Math.floor(d.getMonth() / 3) + 1}`
        ];

        function generateData({ email, rows = 650 }) {
            const seed = `${email}#q-excel-operational-metrics`;
            const rnd = seedrandom(seed);
            const MARGIN_RATE = 0.37;
            const sheet = [];
            const raw = [];
            // header
            sheet.push(["Record ID", "Region", "Closing Period", "Revenue (reported)", "Expense (reported)", "Ops Notes", "Controller Comments"]);

            for (let i = 0; i < rows; i++) {
                const region = pick(regions, rnd);
                const category = pick(categories, rnd);
                const team = pick(teams, rnd);
                const period = randomDateBetween(new Date(2023,0,1), new Date(2024,11,31), rnd);
                const revenue = Math.floor(rnd() * 85000) + 15000; // 15k - 100k
                const multiplier = 1 + rnd() * 0.1;
                const reportedRevenue = Math.round(revenue * multiplier);
                const hasExpense = rnd() > 0.18;
                const expenseRaw = reportedRevenue * (0.42 + rnd() * 0.28);
                const reportedExpense = hasExpense ? Math.round(expenseRaw) : null;
                const recordId = `RC-${String(i+1).padStart(5,"0")}`;
                const regionLabel = rnd() < 0.5 ? region.canonical : pick(region.variants, rnd);
                const periodLabel = pick(dateFormats, rnd)(period);
                const opsNotes = `${pick(["Reviewed via reconciliation workbook", "Pending vendor accrual confirmation", "Include in true-up journal", "Adjust for FX in final submission", "Validated by controller team", "Cross-check with warehouse logs", "Flagged for automation audit"], rnd)}; ref #${Math.floor(rnd() * 9000 + 1000)}`;
                const sheetRow = [
                    addRandomSpaces(recordId, rnd),
                    addRandomSpaces(regionLabel, rnd),
                    addRandomSpaces(periodLabel, rnd),
                    // revenue (display)
                    rnd() < 0.5 ? addRandomSpaces(fmtMoney(reportedRevenue) + " USD", rnd) : addRandomSpaces(fmtMoney(reportedRevenue), rnd),
                    reportedExpense === null ? (rnd() < 0.5 ? "" : "USD TBD") : addRandomSpaces(fmtMoney(reportedExpense), rnd),
                    addRandomSpaces(`${category}|${team}|${period.getFullYear()}-${String(Math.floor(period.getMonth()/3)+1).padStart(2,"0")}`, rnd),
                    addRandomSpaces(opsNotes, rnd)
                ];
                sheet.push(sheetRow);
                raw.push({ region: region.canonical, category, team, period, revenue: reportedRevenue, expense: reportedExpense });
            }

            // Build workbook (xlsx)
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(sheet);
            XLSX.utils.book_append_sheet(wb, ws, "Operational Close");
            const arrayBuffer = XLSX.write(wb, { bookType: "xlsx", type: "array" });
            const blob = new Blob([arrayBuffer], { type: "application/octet-stream" });


            const targetRegion = "Asia Pacific";
            const targetCategory = "Billing";
            const cutoff = new Date(2024, 5, 6); // 06 Jun 2024 (months are 0-indexed)

            const m = raw
                .filter(r => r.region === targetRegion && r.category === targetCategory && r.period.getTime() <= cutoff.getTime())
                .reduce((acc, r) => {
                    const expense = (r.expense === null) ? r.revenue * MARGIN_RATE : r.expense;
                    return acc + (r.revenue - expense);
                }, 0);

            return { sheet, raw, blob, consolidated: { region: targetRegion, category: targetCategory, cutoff, value: m } }; return { sheet, raw, blob, consolidated: { region: "Asia Pacific", category: "Billing", cutoff, value: m } };
        }

        // Render helpers
        const container = document.getElementById("tableContainer");
        const answerEl = document.getElementById("answer");
        const downloadBtn = document.getElementById("download");
        let lastBlob = null;
        document.getElementById("generate").addEventListener("click", () => {
            const email = document.getElementById("email").value || "24f3001383@ds.study.iitm.ac.in";
            const { sheet, raw, blob, consolidated } = generateData({ email, rows: 650 });
            lastBlob = blob;
            // Build HTML table (render first 250 rows for performance)
            const maxRows = 250;
            const rowsToShow = sheet.slice(0, maxRows + 1); // include header
            const table = document.createElement("table");
            const thead = document.createElement("thead");
            thead.innerHTML = "<tr>" + rowsToShow[0].map(h => `<th>${h}</th>`).join("") + "</tr>";
            table.appendChild(thead);
            const tbody = document.createElement("tbody");
            for (let r = 1; r < rowsToShow.length; r++) {
                const tr = document.createElement("tr");
                for (const cell of rowsToShow[r]) {
                    const td = document.createElement("td");
                    td.textContent = cell;
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }
            table.appendChild(tbody);
            container.innerHTML = "";
            container.appendChild(table);
            // Show computed consolidated margin
            const nf = new Intl.NumberFormat("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            answerEl.textContent = `Consolidated result for region="${consolidated.region}", category="${consolidated.category}", cutoff=${consolidated.cutoff.toLocaleDateString()}: ${consolidated.value >= 0 ? "$" + nf.format(consolidated.value) : "-$" + nf.format(Math.abs(consolidated.value))}`;
            downloadBtn.disabled = false;
        });

        downloadBtn.addEventListener("click", () => {
            if (!lastBlob) return;
            const a = document.createElement("a");
            a.href = URL.createObjectURL(lastBlob);
            a.download = "operational_close.xlsx";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        });

        // Generate once on load
        document.getElementById("generate").click();
    </script>
</body>
</html>